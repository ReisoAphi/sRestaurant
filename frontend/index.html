<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>TPV para Restaurante</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Vue.js 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- Vue Router -->
    <script src="https://unpkg.com/vue-router@4/dist/vue-router.global.js"></script>
    <!-- Vue Demi (Dependencia para Pinia) -->
    <script src="https://unpkg.com/vue-demi"></script>
    <!-- Pinia -->
    <script src="https://unpkg.com/pinia@2/dist/pinia.iife.js"></script>
    <!-- Axios -->
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <!-- Socket.IO Client -->
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <style>
        body { font-family: 'Inter', sans-serif; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        .fade-enter-active, .fade-leave-active { transition: opacity 0.2s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
        .bottom-nav-link.router-link-active { color: #10b981; /* emerald-500 */ }
    </style>
</head>
<body class="bg-gray-100">
    <div id="app">
        <!-- El contenido se renderizará aquí por Vue Router -->
    </div>

    <script type="module">
        const { createApp, ref, computed, onMounted, onBeforeUnmount, watch, nextTick } = Vue;
        const { createRouter, createWebHashHistory } = VueRouter;
        const { createPinia, defineStore } = Pinia;

        // --- CONFIGURACIÓN DINÁMICA DE LA API ---
        const backendHostname = window.location.hostname || 'localhost';
        const backendUrl = `http://${backendHostname}:3000`;

        // --- SERVICIO API (Axios) ---
        const apiClient = axios.create({
            baseURL: `${backendUrl}/api`,
            headers: { 'Content-Type': 'application/json' }
        });

        // Interceptor para añadir el token a las peticiones
        apiClient.interceptors.request.use(config => {
            const token = localStorage.getItem('token');
            if (token) {
                config.headers.Authorization = `Bearer ${token}`;
            }
            return config;
        }, error => {
            return Promise.reject(error);
        });

        // --- STORE DE AUTENTICACIÓN (Pinia) ---
        const useAuthStore = defineStore('auth', () => {
            const user = ref(JSON.parse(localStorage.getItem('user')) || null);
            const token = ref(localStorage.getItem('token') || null);
            const isLoginModalOpen = ref(false);

            const isAuthenticated = computed(() => !!token.value);
            
            function openLoginModal() { isLoginModalOpen.value = true; }
            function closeLoginModal() { isLoginModalOpen.value = false; }

            async function login(credentials) {
                const response = await apiClient.post('/auth/login', credentials);
                const { token: newToken, user: userData } = response.data;
                
                localStorage.setItem('token', newToken);
                localStorage.setItem('user', JSON.stringify(userData));
                token.value = newToken;
                user.value = userData;

                let redirectPath = '/';
                if (userData.role === 'administrador') redirectPath = '/dashboard';
                else if (userData.role === 'mesero') redirectPath = '/mesero';
                else if (userData.role === 'cocinero') redirectPath = '/cocina';
                
                router.push(redirectPath);
                closeLoginModal();
            }

            function logout() {
                localStorage.removeItem('token');
                localStorage.removeItem('user');
                token.value = null;
                user.value = null;
                router.push('/');
            }
            
            function hasRole(roles) {
                if (!user.value || !user.value.role) return false;
                return roles.includes(user.value.role);
            }

            return { user, token, isAuthenticated, isLoginModalOpen, openLoginModal, closeLoginModal, login, logout, hasRole };
        });
        
        // --- STORE DEL CARRITO ---
        const useCartStore = defineStore('cart', () => {
            const items = ref([]);
            const mesaNombre = ref('Cliente');
            const consumerOrderId = ref(localStorage.getItem('consumerOrderId') || null);

            const subtotal = computed(() => items.value.reduce((acc, item) => acc + (parseFloat(item.precio) * item.cantidad), 0));
            const impuestos = computed(() => subtotal.value * 0.16);
            const total = computed(() => subtotal.value + impuestos.value);

            const totalItems = computed(() => items.value.reduce((acc, item) => acc + item.cantidad, 0));

            function addItem(producto) {
                const existingItem = items.value.find(item => item.id === producto.id);
                if (existingItem) existingItem.cantidad++;
                else items.value.push({ ...producto, cantidad: 1 });
            }
            function removeItem(productoId) {
                items.value = items.value.filter(item => item.id !== productoId);
            }
            function updateQuantity(productoId, cantidad) {
                const item = items.value.find(i => i.id === productoId);
                if (item) (cantidad > 0) ? item.cantidad = cantidad : removeItem(productoId);
            }
            async function submitPedido() {
                if (items.value.length === 0) return false;
                const pedidoBody = {
                    mesa_nombre: mesaNombre.value,
                    detalles: items.value.map(item => ({ productoId: item.id, cantidad: item.cantidad }))
                };
                const response = await apiClient.post('/pedidos', pedidoBody);
                const newOrderId = response.data.id;
                consumerOrderId.value = newOrderId;
                localStorage.setItem('consumerOrderId', newOrderId);
                resetCart();
                router.push('/mi-pedido');
                return true;
            }
             async function submitWaiterPedido() {
                if (items.value.length === 0) return false;
                const pedidoBody = {
                    mesa_nombre: mesaNombre.value,
                    detalles: items.value.map(item => ({ productoId: item.id, cantidad: item.cantidad })),
                    estado: 'en validacion'
                };
                const response = await apiClient.post('/pedidos', pedidoBody);
                resetCart();
                return response.data; // Devolver el pedido completo
            }
            function resetCart() { items.value = []; }
            function clearConsumerOrder() {
                consumerOrderId.value = null;
                localStorage.removeItem('consumerOrderId');
            }
            return { items, mesaNombre, totalItems, subtotal, impuestos, total, consumerOrderId, addItem, removeItem, updateQuantity, submitPedido, submitWaiterPedido, resetCart, clearConsumerOrder };
        });

        // --- COMPONENTES Y VISTAS ---
        const formatCurrency = (value) => new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN' }).format(value || 0);
        
        const LoginModal = {
            template: `
                <div v-if="auth.isLoginModalOpen" @click.self="auth.closeLoginModal()" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                    <div class="w-full max-w-md bg-white rounded-lg shadow-md p-8 relative">
                        <button @click="auth.closeLoginModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                            <i class="ph ph-x text-2xl"></i>
                        </button>
                        <div class="text-center mb-8">
                            <i class="ph-duotone ph-storefront text-6xl text-emerald-500"></i>
                            <h1 class="text-3xl font-bold text-gray-800 mt-2">Acceso Staff</h1>
                            <p class="text-gray-500">Inicia sesión para continuar</p>
                        </div>
                        <form @submit.prevent="handleLogin">
                            <div v-if="error" class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mb-6" role="alert">
                                <p>{{ error }}</p>
                            </div>
                            <div class="mb-4">
                                <label for="username" class="block text-sm font-medium text-gray-700">Usuario</label>
                                <input v-model="username" type="text" id="username" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-emerald-500 focus:border-emerald-500" required>
                            </div>
                            <div class="mb-6">
                                <label for="password" class="block text-sm font-medium text-gray-700">Contraseña</label>
                                <input v-model="password" type="password" id="password" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-emerald-500 focus:border-emerald-500" required>
                            </div>
                            <button type="submit" :disabled="loading" class="w-full py-3 px-4 bg-emerald-500 text-white font-bold rounded-lg hover:bg-emerald-600 transition-colors disabled:opacity-75 disabled:cursor-not-allowed flex items-center justify-center">
                                <i v-if="loading" class="ph-duotone ph-spinner-gap animate-spin text-2xl mr-2"></i>
                                <span>{{ loading ? 'Ingresando...' : 'Ingresar' }}</span>
                            </button>
                        </form>
                    </div>
                </div>`,
            setup() {
                const auth = useAuthStore();
                const username = ref('');
                const password = ref('');
                const loading = ref(false);
                const error = ref(null);
                const handleLogin = async () => {
                    loading.value = true;
                    error.value = null;
                    try {
                        await auth.login({ username: username.value, password: password.value });
                    } catch (err) {
                        error.value = err.response?.data?.message || 'Error al iniciar sesión. Inténtalo de nuevo.';
                    } finally {
                        loading.value = false;
                    }
                };
                return { auth, username, password, loading, error, handleLogin };
            }
        };

        const CartComponent = {
            props: { isWaiter: { type: Boolean, default: false } },
            template: `
                <div class="bg-white rounded-lg shadow-lg p-6 flex flex-col h-full">
                    <h2 class="text-2xl font-bold text-gray-800 border-b pb-4 mb-4">Orden Actual</h2>
                    <div v-if="isWaiter" class="mb-4">
                        <label for="mesa" class="block text-sm font-medium text-gray-700">Nombre de la Mesa / Cliente</label>
                        <input type="text" id="mesa" v-model="cart.mesaNombre" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-emerald-500 focus:border-emerald-500 sm:text-sm">
                    </div>
                    <div class="flex-1 overflow-y-auto pr-2">
                        <div v-if="cart.items.length === 0" class="text-center text-gray-500 py-10">
                            <i class="ph-duotone ph-shopping-cart text-5xl"></i>
                            <p class="mt-2">Añade productos para empezar</p>
                        </div>
                        <ul v-else class="divide-y divide-gray-200">
                            <li v-for="item in cart.items" :key="item.id" class="py-3 flex items-center">
                                <div class="flex-1">
                                    <p class="font-semibold text-gray-800">{{ item.nombre }}</p>
                                    <p class="text-sm text-gray-500">{{ formatCurrency(item.precio) }}</p>
                                </div>
                                <div class="flex items-center">
                                    <input type="number" min="1" :value="item.cantidad" @change="updateQuantity(item.id, $event.target.value)" class="w-16 text-center border-gray-300 rounded-md">
                                    <button @click="cart.removeItem(item.id)" class="ml-3 text-red-500 hover:text-red-700">
                                        <i class="ph ph-trash text-xl"></i>
                                    </button>
                                </div>
                            </li>
                        </ul>
                    </div>
                    <div v-if="cart.totalItems > 0" class="border-t pt-4 mt-4 space-y-2 text-gray-700">
                        <div class="flex justify-between"><span>Subtotal</span><span class="font-medium">{{ formatCurrency(cart.subtotal) }}</span></div>
                        <div class="flex justify-between"><span>Impuestos (16%)</span><span class="font-medium">{{ formatCurrency(cart.impuestos) }}</span></div>
                        <div class="flex justify-between text-xl font-bold text-gray-900"><span>Total</span><span>{{ formatCurrency(cart.total) }}</span></div>
                    </div>
                    <div class="mt-6">
                        <button @click="handleCheckout" class="w-full py-3 px-4 bg-emerald-500 text-white font-bold rounded-lg hover:bg-emerald-600 transition-colors disabled:opacity-50" :disabled="cart.totalItems === 0 || isSubmitting">
                            <span v-if="isSubmitting">Enviando...</span>
                            <span v-else>{{ isWaiter ? 'Enviar a Cocina' : 'Realizar Pedido' }}</span>
                        </button>
                    </div>
                </div>`,
            setup(props) {
                const cart = useCartStore();
                const router = VueRouter.useRouter();
                const isSubmitting = ref(false);
                const updateQuantity = (id, newQty) => cart.updateQuantity(id, parseInt(newQty, 10));
                const handleCheckout = async () => {
                    if (isSubmitting.value) return;
                    isSubmitting.value = true;
                    try {
                        if (props.isWaiter) {
                            const success = await cart.submitWaiterPedido();
                            if(success) {
                                alert('¡Pedido enviado a cocina!');
                                router.push('/mesero');
                            }
                        } else {
                            await cart.submitPedido();
                        }
                    } catch (error) {
                        console.error("Error al enviar el pedido:", error);
                        alert("Hubo un problema al enviar tu pedido. Inténtalo de nuevo.");
                    } finally {
                        isSubmitting.value = false;
                    }
                }
                return { cart, isSubmitting, formatCurrency, updateQuantity, handleCheckout };
            }
        };

        const ProductCard = {
            props: ['product'],
            emits: ['add-to-cart'],
            template: `
                <div @click="$emit('add-to-cart', product)" class="bg-white rounded-lg shadow-md overflow-hidden cursor-pointer hover:shadow-xl transition-shadow duration-300 transform hover:-translate-y-1 flex flex-col">
                    <div class="h-40 bg-gray-200 flex items-center justify-center relative overflow-hidden">
                        <img v-if="product.imagen_url" :src="product.imagen_url" @error="onImageError" class="w-full h-full object-cover" :alt="'Imagen de ' + product.nombre">
                        <i v-else class="ph-duotone ph-hamburger text-6xl text-gray-400"></i>
                    </div>
                    <div class="p-4 flex-1 flex flex-col justify-between">
                        <div>
                            <h3 class="font-semibold text-gray-800 truncate">{{ product.nombre }}</h3>
                            <p v-if="product.descripcion" class="text-xs text-gray-500 mt-1 h-8 overflow-hidden">{{ product.descripcion }}</p>
                        </div>
                        <p class="text-emerald-600 font-bold mt-2">{{ formatCurrency(product.precio) }}</p>
                    </div>
                </div>`,
            setup() {
                const onImageError = (event) => {
                    const placeholder = document.createElement('div');
                    placeholder.className = 'w-full h-full flex items-center justify-center bg-gray-100';
                    placeholder.innerHTML = '<i class="ph-duotone ph-image-broken text-5xl text-gray-400"></i>';
                    event.target.parentNode.replaceChild(placeholder, event.target);
                };
                return { formatCurrency, onImageError };
            }
        };

        const AddItemsModal = {
            props: ['pedidoId', 'isVisible'],
            emits: ['close', 'items-added'],
            components: { ProductCard },
            template: `
                <div v-if="isVisible" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4">
                    <div class="w-full max-w-4xl h-[90vh] bg-white rounded-lg shadow-xl flex flex-col">
                        <header class="p-4 border-b flex justify-between items-center">
                            <h2 class="text-2xl font-bold text-gray-800">Añadir a Pedido #{{ pedidoId }}</h2>
                            <button @click="$emit('close')" class="text-gray-400 hover:text-gray-600">
                                <i class="ph ph-x text-3xl"></i>
                            </button>
                        </header>
                        
                        <div class="flex-1 flex flex-col md:flex-row gap-6 p-4 overflow-hidden">
                            <!-- Columna de Productos -->
                            <div class="w-full md:w-2/3 flex flex-col">
                                <div class="mb-4"><input type="text" v-model="searchTerm" placeholder="Buscar producto..." class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500"></div>
                                <div class="flex flex-wrap gap-2 mb-4">
                                    <button @click="selectedCategory = null" :class="{'bg-emerald-500 text-white': selectedCategory === null, 'bg-white text-gray-700': selectedCategory !== null}" class="px-4 py-2 rounded-full shadow-sm text-sm font-medium hover:bg-emerald-100 transition-colors">Todos</button>
                                    <button v-for="category in categories" :key="category.id" @click="selectedCategory = category.id" :class="{'bg-emerald-500 text-white': selectedCategory === category.id, 'bg-white text-gray-700': selectedCategory !== category.id}" class="px-4 py-2 rounded-full shadow-sm text-sm font-medium hover:bg-emerald-100 transition-colors">{{ category.nombre }}</button>
                                </div>
                                <div v-if="loading" class="flex-1 flex items-center justify-center"><i class="ph-duotone ph-spinner-gap animate-spin text-5xl text-emerald-500"></i></div>
                                <div v-else-if="filteredProducts.length === 0" class="flex-1 flex items-center justify-center"><p>No se encontraron productos.</p></div>
                                <div v-else class="flex-1 overflow-y-auto pr-2 grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-4">
                                    <ProductCard v-for="product in filteredProducts" :key="product.id" :product="product" @add-to-cart="addItem"/>
                                </div>
                            </div>

                            <!-- Columna de Carrito de Adición -->
                            <div class="w-full md:w-1/3 bg-gray-50 rounded-lg p-4 flex flex-col">
                                <h3 class="text-xl font-bold text-gray-800 border-b pb-3 mb-3">Nuevos Items</h3>
                                <div class="flex-1 overflow-y-auto">
                                    <div v-if="newItems.length === 0" class="text-center text-gray-500 py-10">
                                        <p>Añade productos del menú.</p>
                                    </div>
                                    <ul v-else class="divide-y divide-gray-200">
                                        <li v-for="item in newItems" :key="item.id" class="py-2 flex items-center">
                                            <div class="flex-1">
                                                <p class="font-semibold text-gray-800">{{ item.nombre }}</p>
                                                <p class="text-sm text-gray-500">{{ formatCurrency(item.precio) }}</p>
                                            </div>
                                            <div class="flex items-center">
                                                <input type="number" min="1" :value="item.cantidad" @change="updateQuantity(item.id, $event.target.value)" class="w-16 text-center border-gray-300 rounded-md">
                                                <button @click="removeItem(item.id)" class="ml-2 text-red-500 hover:text-red-700"><i class="ph ph-trash"></i></button>
                                            </div>
                                        </li>
                                    </ul>
                                </div>
                                <div class="border-t pt-4 mt-4">
                                    <button @click="confirmAddItems" class="w-full py-3 bg-blue-500 text-white font-bold rounded-lg hover:bg-blue-600 transition-colors disabled:opacity-50" :disabled="newItems.length === 0 || isSubmitting">
                                        <span v-if="isSubmitting">Añadiendo...</span>
                                        <span v-else>Confirmar Adición</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>`,
            setup(props, { emit }) {
                const products = ref([]);
                const categories = ref([]);
                const loading = ref(true);
                const searchTerm = ref('');
                const selectedCategory = ref(null);
                const newItems = ref([]);
                const isSubmitting = ref(false);

                const fetchProductsAndCategories = async () => {
                    try {
                        loading.value = true;
                        const productsRes = await apiClient.get('/productos');
                        products.value = productsRes.data;
                        const uniqueCategories = productsRes.data.reduce((acc, p) => {
                            if (p.categoria && !acc.some(c => c.id === p.categoria.id)) acc.push(p.categoria);
                            return acc;
                        }, []);
                        categories.value = uniqueCategories;
                    } catch (error) {
                        console.error("Error al cargar datos del menú:", error);
                    } finally {
                        loading.value = false;
                    }
                };

                const filteredProducts = computed(() => {
                    let filtered = products.value;
                    if (selectedCategory.value) filtered = filtered.filter(p => p.categoriaId === selectedCategory.value);
                    if (searchTerm.value) filtered = filtered.filter(p => p.nombre.toLowerCase().includes(searchTerm.value.toLowerCase()));
                    return filtered;
                });

                const addItem = (producto) => {
                    const existingItem = newItems.value.find(item => item.id === producto.id);
                    if (existingItem) existingItem.cantidad++;
                    else newItems.value.push({ ...producto, cantidad: 1 });
                };
                const removeItem = (productoId) => {
                    newItems.value = newItems.value.filter(item => item.id !== productoId);
                };
                const updateQuantity = (productoId, cantidad) => {
                    const item = newItems.value.find(i => i.id === productoId);
                    if (item) (cantidad > 0) ? item.cantidad = parseInt(cantidad) : removeItem(productoId);
                };
                
                const confirmAddItems = async () => {
                    if (isSubmitting.value || newItems.value.length === 0) return;
                    isSubmitting.value = true;
                    try {
                        const payload = {
                            detalles: newItems.value.map(item => ({ productoId: item.id, cantidad: item.cantidad }))
                        };
                        await apiClient.post(`/pedidos/${props.pedidoId}/add-items`, payload);
                        emit('items-added');
                        emit('close');
                    } catch (error) {
                        console.error("Error al añadir items:", error);
                        alert(error.response?.data?.message || 'No se pudieron añadir los productos.');
                    } finally {
                        isSubmitting.value = false;
                    }
                };

                watch(() => props.isVisible, (newValue) => {
                    if (newValue) {
                        newItems.value = [];
                        searchTerm.value = '';
                        selectedCategory.value = null;
                        if (products.value.length === 0) {
                            fetchProductsAndCategories();
                        }
                    }
                });

                return { loading, categories, searchTerm, selectedCategory, filteredProducts, newItems, isSubmitting, addItem, removeItem, updateQuantity, confirmAddItems, formatCurrency };
            }
        };

        const OrderCard = {
            props: ['order'],
            emits: ['order-updated'],
            components: { AddItemsModal },
            template: `
                <div class="bg-white rounded-lg shadow-md p-5 flex flex-col" :class="getCardBorder(localOrder.estado)">
                    <div class="flex justify-between items-start mb-3">
                        <h3 class="text-xl font-bold text-gray-800">{{ localOrder.mesa_nombre }} - #{{ localOrder.id }}</h3>
                        <span class="text-lg font-bold flex items-center gap-1" :class="getStatusColor(localOrder.estado)">
                            <i class="ph-duotone ph-timer"></i>
                            <span>{{ calculateElapsedTime(localOrder.createdAt) }}</span>
                        </span>
                    </div>
                    <p class="mb-3 font-semibold capitalize" :class="getStatusColor(localOrder.estado)">Estado: {{ getStatusText(localOrder.estado) }}</p>
                    <ul class="flex-1 border-t border-b border-gray-200 py-3 my-3 space-y-2">
                        <li v-for="detalle in localOrder.detalles" :key="detalle.id" class="flex justify-between items-center"><span class="text-gray-700">{{ detalle.producto.nombre }}</span><span class="font-bold text-emerald-600">x {{ detalle.cantidad }}</span></li>
                    </ul>
                    
                    <div v-if="!localOrder.pagado" class="border-t border-gray-200 pt-3 mt-3">
                        <div class="flex justify-between items-center text-lg font-bold text-gray-800">
                            <span>Total a Cobrar:</span>
                            <span>{{ formatCurrency(localOrder.total) }}</span>
                        </div>
                    </div>

                    <div class="mt-4 space-y-2">
                        <button v-if="!localOrder.pagado" @click="openAddItemsModal(localOrder)" class="w-full bg-gray-500 text-white font-bold py-2 rounded-lg hover:bg-gray-600 flex items-center justify-center gap-2">
                            <i class="ph ph-plus-circle"></i>
                            <span>Añadir Items</span>
                        </button>
                        <button v-if="localOrder.estado === 'en validacion'" @click="openConfirmationModal(localOrder, 'en preparacion')" class="w-full bg-blue-500 text-white font-bold py-2 rounded-lg hover:bg-blue-600">Validar Pedido</button>
                        <button v-if="localOrder.estado === 'listo para entregar'" @click="openConfirmationModal(localOrder, 'entregado')" class="w-full bg-purple-500 text-white font-bold py-2 rounded-lg hover:bg-purple-600">Marcar como Entregado</button>
                        
                        <div class="flex gap-2">
                            <button @click="openConfirmationModal(localOrder, 'pagar')" class="w-full bg-emerald-500 text-white font-bold py-2 rounded-lg hover:bg-emerald-600 disabled:opacity-50 disabled:cursor-not-allowed" :disabled="localOrder.pagado">
                                <span v-if="!localOrder.pagado">Pagar</span>
                                <span v-else class="flex items-center justify-center gap-2"><i class="ph ph-check-circle"></i> Pagado</span>
                            </button>
                            <button v-if="!localOrder.pagado" @click="openConfirmationModal(localOrder, 'cancelar')" class="w-full bg-red-500 text-white font-bold py-2 rounded-lg hover:bg-red-600">Cancelar</button>
                        </div>
                    </div>
                </div>
                
                <div v-if="confirmation.isOpen" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4">
                    <div class="w-full max-w-sm bg-white rounded-lg shadow-xl p-6 text-center">
                        <i :class="confirmation.icon" class="text-5xl mb-4"></i>
                        <h3 class="text-lg font-semibold text-gray-800 mb-2">Confirmar Acción</h3>
                        <p class="text-gray-600 mb-6">{{ confirmation.message }}</p>
                        <div class="flex justify-center gap-4">
                            <button @click="closeConfirmationModal" class="px-6 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">Cancelar</button>
                            <button @click="executeConfirmation" :class="confirmation.confirmButtonClass" class="px-6 py-2 text-white font-semibold rounded-lg">Confirmar</button>
                        </div>
                    </div>
                </div>

                <AddItemsModal 
                    :is-visible="addItemsModal.isOpen" 
                    :pedido-id="addItemsModal.pedidoId"
                    @close="closeAddItemsModal"
                    @items-added="fetchOrder"
                />
            `,
            setup(props, { emit }) {
                const localOrder = ref(JSON.parse(JSON.stringify(props.order)));
                const currentTime = ref(new Date());
                const confirmation = ref({ isOpen: false, message: '', icon: '', confirmButtonClass: '', onConfirm: () => {} });
                const addItemsModal = ref({ isOpen: false, pedidoId: null });
                let timerIntervalId = null;

                const fetchOrder = async () => {
                    try {
                        const response = await apiClient.get(`/pedidos/${localOrder.value.id}`);
                        localOrder.value = response.data;
                        emit('order-updated', response.data);
                    } catch (error) {
                        console.error("Error fetching order:", error);
                    }
                };

                const updateOrderStatus = async (pedidoId, nuevoEstado) => {
                    try { 
                        const response = await apiClient.patch(`/pedidos/${pedidoId}/estado`, { estado: nuevoEstado });
                        localOrder.value = response.data;
                        emit('order-updated', response.data);
                    } catch (error) { console.error("Error al actualizar estado:", error); }
                };

                const markAsPaid = async (pedidoId) => {
                    try {
                        const response = await apiClient.patch(`/pedidos/${pedidoId}/pagar`);
                        localOrder.value = response.data;
                        emit('order-updated', response.data);
                    } catch(error) { console.error("Error al marcar como pagado:", error); }
                };

                const openConfirmationModal = (pedido, action) => {
                    const details = {
                        'en preparacion': { message: `¿Confirmas validar el pedido #${pedido.id} y enviarlo a cocina?`, icon: 'ph-duotone ph-question text-blue-500', confirmButtonClass: 'bg-blue-500 hover:bg-blue-600', onConfirm: () => updateOrderStatus(pedido.id, 'en preparacion') },
                        'entregado': { message: `¿Confirmas que el pedido #${pedido.id} ha sido entregado al cliente?`, icon: 'ph-duotone ph-smiley text-purple-500', confirmButtonClass: 'bg-purple-500 hover:bg-purple-600', onConfirm: () => updateOrderStatus(pedido.id, 'entregado') },
                        'pagar': { message: `¿Confirmas el pago de ${formatCurrency(pedido.total)} para el pedido #${pedido.id}?`, icon: 'ph-duotone ph-money text-emerald-500', confirmButtonClass: 'bg-emerald-500 hover:bg-emerald-600', onConfirm: () => markAsPaid(pedido.id) },
                        'cancelar': { message: `¿Estás seguro de que quieres CANCELAR el pedido #${pedido.id}?`, icon: 'ph-duotone ph-warning-circle text-red-500', confirmButtonClass: 'bg-red-500 hover:bg-red-600', onConfirm: () => updateOrderStatus(pedido.id, 'cancelado') }
                    };
                    confirmation.value = { ...details[action], isOpen: true };
                };

                const closeConfirmationModal = () => { confirmation.value.isOpen = false; };
                const executeConfirmation = () => { confirmation.value.onConfirm(); closeConfirmationModal(); };

                const openAddItemsModal = (pedido) => { addItemsModal.value = { isOpen: true, pedidoId: pedido.id }; };
                const closeAddItemsModal = () => { addItemsModal.value = { isOpen: false, pedidoId: null }; };

                const calculateElapsedTime = (startTime) => {
                    const start = new Date(startTime);
                    const elapsed = Math.floor((currentTime.value.getTime() - start.getTime()) / 1000);
                    if (elapsed < 0) return '00:00';
                    const minutes = Math.floor(elapsed / 60).toString().padStart(2, '0');
                    const seconds = (elapsed % 60).toString().padStart(2, '0');
                    return `${minutes}:${seconds}`;
                };

                const getStatusText = (estado) => (estado.replace('_', ' '));
                const getStatusColor = (estado) => ({ 'en validacion': 'text-gray-500', 'en preparacion': 'text-yellow-600', 'listo para entregar': 'text-blue-600', 'entregado': 'text-purple-600' }[estado] || 'text-gray-500');
                const getCardBorder = (estado) => ({ 'en validacion': 'border-l-4 border-gray-400', 'en preparacion': 'border-l-4 border-yellow-500', 'listo para entregar': 'border-l-4 border-blue-500', 'entregado': 'border-l-4 border-purple-500' }[estado] || '');
                
                watch(() => props.order, (newOrder) => {
                    localOrder.value = JSON.parse(JSON.stringify(newOrder));
                }, { deep: true });

                onMounted(() => {
                    timerIntervalId = setInterval(() => {
                        currentTime.value = new Date();
                    }, 1000);
                });

                onBeforeUnmount(() => {
                    if (timerIntervalId) clearInterval(timerIntervalId);
                });

                return { localOrder, confirmation, addItemsModal, openConfirmationModal, closeConfirmationModal, executeConfirmation, openAddItemsModal, closeAddItemsModal, calculateElapsedTime, getStatusText, getStatusColor, getCardBorder, formatCurrency, fetchOrder };
            }
        };
        
        const TakeOrderView = {
            components: { ProductCard, CartComponent },
            template: `
                <div class="flex flex-col md:flex-row gap-6 h-full">
                    <div class="w-full md:w-2/3">
                        <div class="mb-4"><input type="text" v-model="searchTerm" placeholder="Buscar producto..." class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500"></div>
                        <div class="flex flex-wrap gap-2 mb-6">
                             <button @click="selectedCategory = null" :class="{'bg-emerald-500 text-white': selectedCategory === null, 'bg-white text-gray-700': selectedCategory !== null}" class="px-4 py-2 rounded-full shadow-sm text-sm font-medium hover:bg-emerald-100 transition-colors">Todos</button>
                            <button v-for="category in categories" :key="category.id" @click="selectedCategory = category.id" :class="{'bg-emerald-500 text-white': selectedCategory === category.id, 'bg-white text-gray-700': selectedCategory !== category.id}" class="px-4 py-2 rounded-full shadow-sm text-sm font-medium hover:bg-emerald-100 transition-colors">{{ category.nombre }}</button>
                        </div>
                        <div v-if="loading" class="text-center py-10"><i class="ph-duotone ph-spinner-gap animate-spin text-5xl text-emerald-500"></i><p class="mt-2 text-gray-600">Cargando productos...</p></div>
                        <div v-else-if="filteredProducts.length === 0" class="text-center py-10"><i class="ph-duotone ph-smiley-sad text-5xl text-gray-400"></i><p class="mt-2 text-gray-600">No se encontraron productos.</p></div>
                        <transition-group name="slide-up" tag="div" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4">
                             <ProductCard v-for="product in filteredProducts" :key="product.id" :product="product" @add-to-cart="cart.addItem"/>
                        </transition-group>
                    </div>
                    <div class="w-full md:w-1/3 hidden md:flex flex-col"><CartComponent :is-waiter="false" /></div>
                </div>`,
            setup() {
                const cart = useCartStore();
                const products = ref([]);
                const categories = ref([]);
                const loading = ref(true);
                const searchTerm = ref('');
                const selectedCategory = ref(null);
                const fetchProductsAndCategories = async () => {
                    try {
                        loading.value = true;
                        const productsRes = await apiClient.get('/productos');
                        products.value = productsRes.data;
                        const categoriesRes = await apiClient.get('/categorias');
                        categories.value = categoriesRes.data;
                    } catch (error) {
                        console.error("Error al cargar datos:", error);
                        alert("No se pudo conectar con el servidor. Asegúrate de que el backend esté corriendo y los endpoints de productos sean públicos.");
                    } finally {
                        loading.value = false;
                    }
                };
                const filteredProducts = computed(() => {
                    let filtered = products.value;
                    if (selectedCategory.value) filtered = filtered.filter(p => p.categoriaId === selectedCategory.value);
                    if (searchTerm.value) filtered = filtered.filter(p => p.nombre.toLowerCase().includes(searchTerm.value.toLowerCase()));
                    return filtered;
                });
                onMounted(fetchProductsAndCategories);
                return { cart, products, categories, loading, searchTerm, selectedCategory, filteredProducts };
            }
        };

        const WaiterOrderView = {
            components: { ProductCard },
            template: `
                <div class="flex flex-col h-full">
                    <div class="w-full">
                        <div class="mb-4"><input type="text" v-model="searchTerm" placeholder="Buscar producto..." class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500"></div>
                        <div class="flex flex-wrap gap-2 mb-6">
                            <button @click="selectedCategory = null" :class="{'bg-emerald-500 text-white': selectedCategory === null, 'bg-white text-gray-700': selectedCategory !== null}" class="px-4 py-2 rounded-full shadow-sm text-sm font-medium hover:bg-emerald-100 transition-colors">Todos</button>
                            <button v-for="category in categories" :key="category.id" @click="selectedCategory = category.id" :class="{'bg-emerald-500 text-white': selectedCategory === category.id, 'bg-white text-gray-700': selectedCategory !== category.id}" class="px-4 py-2 rounded-full shadow-sm text-sm font-medium hover:bg-emerald-100 transition-colors">{{ category.nombre }}</button>
                        </div>
                        <div v-if="loading" class="text-center py-10"><i class="ph-duotone ph-spinner-gap animate-spin text-5xl text-emerald-500"></i><p class="mt-2 text-gray-600">Cargando productos...</p></div>
                        <div v-else-if="filteredProducts.length === 0" class="text-center py-10"><i class="ph-duotone ph-smiley-sad text-5xl text-gray-400"></i><p class="mt-2 text-gray-600">No se encontraron productos.</p></div>
                        <transition-group name="slide-up" tag="div" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4">
                            <ProductCard v-for="product in filteredProducts" :key="product.id" :product="product" @add-to-cart="cart.addItem"/>
                        </transition-group>
                    </div>
                </div>`,
            setup() {
                const cart = useCartStore();
                const products = ref([]);
                const categories = ref([]);
                const loading = ref(true);
                const searchTerm = ref('');
                const selectedCategory = ref(null);
                const fetchProductsAndCategories = async () => {
                    try {
                        loading.value = true;
                        const productsRes = await apiClient.get('/productos');
                        products.value = productsRes.data;
                        const categoriesRes = await apiClient.get('/categorias');
                        categories.value = categoriesRes.data;
                    } catch (error) {
                        console.error("Error al cargar datos:", error);
                        alert("No se pudo conectar con el servidor.");
                    } finally {
                        loading.value = false;
                    }
                };
                const filteredProducts = computed(() => {
                    let filtered = products.value;
                    if (selectedCategory.value) filtered = filtered.filter(p => p.categoriaId === selectedCategory.value);
                    if (searchTerm.value) filtered = filtered.filter(p => p.nombre.toLowerCase().includes(searchTerm.value.toLowerCase()));
                    return filtered;
                });
                onMounted(fetchProductsAndCategories);
                return { cart, products, categories, loading, searchTerm, selectedCategory, filteredProducts };
            }
        };

        const SubmitOrderView = {
            components: { OrderCard },
            template: `
                <div class="max-w-2xl mx-auto p-4">
                    <div v-if="!submittedOrder">
                        <div class="bg-white rounded-lg shadow-lg p-6 flex flex-col h-full">
                            <h2 class="text-2xl font-bold text-gray-800 border-b pb-4 mb-4">Revisar e Ingresar Pedido</h2>
                            <div v-if="cart.items.length === 0" class="text-center text-gray-500 py-20">
                                <i class="ph-duotone ph-shopping-cart text-6xl"></i>
                                <p class="mt-4 text-lg">No hay productos en la orden.</p>
                                <router-link to="/crear-pedido" class="mt-6 inline-block bg-emerald-500 text-white font-bold py-2 px-6 rounded-lg">
                                    Ir a Crear Pedido
                                </router-link>
                            </div>
                            <template v-else>
                                <div class="mb-4">
                                    <label for="mesa" class="block text-sm font-medium text-gray-700">Nombre de la Mesa / Cliente</label>
                                    <input type="text" id="mesa" v-model="cart.mesaNombre" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-emerald-500 focus:border-emerald-500 sm:text-sm">
                                </div>
                                <div class="flex-1 overflow-y-auto pr-2">
                                    <ul class="divide-y divide-gray-200">
                                        <li v-for="item in cart.items" :key="item.id" class="py-3 flex items-center">
                                            <div class="flex-1">
                                                <p class="font-semibold text-gray-800">{{ item.nombre }}</p>
                                                <p class="text-sm text-gray-500">{{ formatCurrency(item.precio) }}</p>
                                            </div>
                                            <div class="flex items-center">
                                                <input type="number" min="1" :value="item.cantidad" @change="updateQuantity(item.id, $event.target.value)" class="w-16 text-center border-gray-300 rounded-md">
                                                <button @click="cart.removeItem(item.id)" class="ml-3 text-red-500 hover:text-red-700">
                                                    <i class="ph ph-trash text-xl"></i>
                                                </button>
                                            </div>
                                        </li>
                                    </ul>
                                </div>
                                <div class="border-t pt-4 mt-4 space-y-2 text-gray-700">
                                    <div class="flex justify-between"><span>Subtotal</span><span class="font-medium">{{ formatCurrency(cart.subtotal) }}</span></div>
                                    <div class="flex justify-between"><span>Impuestos (16%)</span><span class="font-medium">{{ formatCurrency(cart.impuestos) }}</span></div>
                                    <div class="flex justify-between text-xl font-bold text-gray-900"><span>Total</span><span>{{ formatCurrency(cart.total) }}</span></div>
                                </div>
                                <div class="mt-6">
                                    <button @click="handleCheckout" class="w-full py-3 px-4 bg-emerald-500 text-white font-bold rounded-lg hover:bg-emerald-600 transition-colors disabled:opacity-50" :disabled="cart.totalItems === 0 || isSubmitting">
                                        <span v-if="isSubmitting">Enviando...</span>
                                        <span v-else>Ingresar Orden a Cocina</span>
                                    </button>
                                </div>
                            </template>
                        </div>
                    </div>
                    <div v-else>
                        <div class="mb-4 text-center">
                            <h2 class="text-2xl font-bold text-gray-800">¡Pedido Ingresado!</h2>
                            <p class="text-gray-500">Ahora puedes gestionar el pedido directamente.</p>
                        </div>
                        <OrderCard :order="submittedOrder" @order-updated="updateSubmittedOrder" />
                        <button @click="createNewOrder" class="w-full mt-4 py-3 px-4 bg-gray-800 text-white font-bold rounded-lg hover:bg-gray-700 transition-colors">
                            Crear Nuevo Pedido
                        </button>
                    </div>
                </div>
            `,
            setup() {
                const cart = useCartStore();
                const isSubmitting = ref(false);
                const submittedOrder = ref(null);

                const updateQuantity = (id, newQty) => {
                    cart.updateQuantity(id, parseInt(newQty, 10));
                };

                const handleCheckout = async () => {
                    if (isSubmitting.value) return;
                    isSubmitting.value = true;
                    try {
                        const newOrder = await cart.submitWaiterPedido();
                        submittedOrder.value = newOrder;
                    } catch (error) {
                        console.error("Error al enviar el pedido:", error);
                        alert("Hubo un problema al enviar tu pedido. Inténtalo de nuevo.");
                    } finally {
                        isSubmitting.value = false;
                    }
                };
                
                const createNewOrder = () => {
                    submittedOrder.value = null;
                };

                const updateSubmittedOrder = (updatedOrder) => {
                    submittedOrder.value = updatedOrder;
                };

                return { cart, isSubmitting, submittedOrder, formatCurrency, updateQuantity, handleCheckout, createNewOrder, updateSubmittedOrder };
            }
        };

        const KitchenView = {
            template: `
                <div class="p-2">
                     <div v-if="loading" class="text-center py-20"><i class="ph-duotone ph-spinner-gap animate-spin text-6xl text-emerald-500"></i><p class="mt-4 text-xl text-gray-600">Cargando pedidos...</p></div>
                    <div v-else-if="activePedidos.length === 0" class="text-center py-20"><i class="ph-duotone ph-coffee text-6xl text-gray-400"></i><p class="mt-4 text-xl text-gray-600">No hay pedidos para preparar.</p></div>
                    <transition-group v-else name="slide-up" tag="div" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                        <div v-for="pedido in activePedidos" :key="pedido.id" class="bg-white rounded-lg shadow-md p-5 flex flex-col">
                            <div class="flex justify-between items-start mb-3">
                                <h3 class="text-xl font-bold text-gray-800">{{ pedido.mesa_nombre }} - #{{ pedido.id }}</h3>
                                <span class="text-lg font-bold text-red-600 bg-red-100 px-3 py-1 rounded-full flex items-center gap-1">
                                    <i class="ph-duotone ph-timer"></i>
                                    <span>{{ calculateElapsedTime(pedido.createdAt) }}</span>
                                </span>
                            </div>
                            <ul class="flex-1 border-t border-b border-gray-200 py-3 my-3 space-y-2">
                                <li v-for="detalle in pedido.detalles" :key="detalle.id" class="flex justify-between items-center"><span class="text-gray-700">{{ detalle.producto.nombre }}</span><span class="font-bold text-emerald-600">x {{ detalle.cantidad }}</span></li>
                            </ul>
                            <button @click="updateOrderStatus(pedido.id, 'listo para entregar')" class="w-full mt-4 bg-green-500 text-white font-bold py-2 rounded-lg hover:bg-green-600 transition-colors">Pedido Listo</button>
                        </div>
                    </transition-group>
                </div>`,
            setup() {
                const pedidos = ref([]);
                const loading = ref(true);
                const currentTime = ref(new Date());
                let timerIntervalId = null;
                let socket;

                const fetchPedidos = async () => {
                    try {
                        loading.value = true;
                        const response = await apiClient.get('/pedidos');
                        pedidos.value = response.data;
                    } catch (error) {
                        console.error("Error cargando pedidos:", error);
                    } finally {
                        loading.value = false;
                    }
                };

                const activePedidos = computed(() => {
                    return pedidos.value.filter(p => p.estado === 'en preparacion').sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt));
                });

                const updateOrderStatus = async (pedidoId, nuevoEstado) => {
                    try { 
                        await apiClient.patch(`/pedidos/${pedidoId}/estado`, { estado: nuevoEstado });
                    } catch (error) {
                        console.error("Error al actualizar estado:", error);
                    }
                };

                const calculateElapsedTime = (startTime) => {
                    const start = new Date(startTime);
                    const elapsed = Math.floor((currentTime.value.getTime() - start.getTime()) / 1000);
                    if (elapsed < 0) return '00:00';
                    const minutes = Math.floor(elapsed / 60).toString().padStart(2, '0');
                    const seconds = (elapsed % 60).toString().padStart(2, '0');
                    return `${minutes}:${seconds}`;
                };

                onMounted(() => {
                    fetchPedidos();
                    timerIntervalId = setInterval(() => { currentTime.value = new Date(); }, 1000);
                    socket = io(backendUrl);
                    socket.on("connect", () => console.log("Conectado al servidor de sockets en Cocina:", socket.id));
                    socket.on("nuevo_pedido", (nuevoPedido) => { pedidos.value.unshift(nuevoPedido); });
                    socket.on("pedido_actualizado", (pedidoActualizado) => {
                        const index = pedidos.value.findIndex(p => p.id === pedidoActualizado.id);
                        if (index !== -1) {
                            pedidos.value.splice(index, 1, pedidoActualizado);
                        } else {
                            pedidos.value.unshift(pedidoActualizado);
                        }
                    });
                });

                onBeforeUnmount(() => {
                    if (socket) socket.disconnect();
                    if (timerIntervalId) clearInterval(timerIntervalId);
                });

                return { loading, activePedidos, updateOrderStatus, calculateElapsedTime };
            }
        };

        const WaiterView = {
            components: { OrderCard, AddItemsModal },
            template: `
                <div class="p-2 relative">
                    <!-- Contenedor de Pedidos -->
                    <div v-if="loading" class="text-center py-20"><i class="ph-duotone ph-spinner-gap animate-spin text-6xl text-emerald-500"></i><p class="mt-4 text-xl text-gray-600">Cargando pedidos...</p></div>
                    <div v-else-if="activePedidos.length === 0" class="text-center py-20"><i class="ph-duotone ph-coffee text-6xl text-gray-400"></i><p class="mt-4 text-xl text-gray-600">No hay pedidos por gestionar.</p></div>
                    <transition-group v-else name="slide-up" tag="div" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                        <OrderCard v-for="pedido in activePedidos" :key="pedido.id" :order="pedido" @order-updated="handleOrderUpdate" />
                    </transition-group>
                </div>`,
            setup() {
                const pedidos = ref([]);
                const loading = ref(true);

                const fetchPedidos = async () => {
                    try {
                        loading.value = true;
                        const response = await apiClient.get('/pedidos');
                        pedidos.value = response.data;
                    } catch (error) {
                        console.error("Error cargando pedidos:", error);
                    } finally {
                        loading.value = false;
                    }
                };

                const activePedidos = computed(() => {
                    return pedidos.value.filter(p => {
                        const isCompleted = p.estado === 'entregado' && p.pagado === true;
                        const isCancelled = p.estado === 'cancelado';
                        return !isCompleted && !isCancelled;
                    }).sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt));
                });
                
                const handleOrderUpdate = (updatedOrder) => {
                    const index = pedidos.value.findIndex(p => p.id === updatedOrder.id);
                    if (index !== -1) {
                        pedidos.value.splice(index, 1, updatedOrder);
                    }
                };

                onMounted(() => {
                    fetchPedidos();
                    const socket = io(backendUrl);
                    socket.on("connect", () => console.log("Conectado al servidor de sockets en Mesero:", socket.id));
                    socket.on("nuevo_pedido", (nuevoPedido) => { pedidos.value.unshift(nuevoPedido); });
                    socket.on("pedido_actualizado", (pedidoActualizado) => {
                        const index = pedidos.value.findIndex(p => p.id === pedidoActualizado.id);
                        if (index !== -1) {
                            pedidos.value.splice(index, 1, pedidoActualizado);
                        } else {
                            pedidos.value.unshift(pedidoActualizado);
                        }
                    });
                    onBeforeUnmount(() => {
                        if (socket) socket.disconnect();
                    });
                });

                return { loading, activePedidos, handleOrderUpdate };
            }
        };


        const OrdersHistoryView = {
            template: `
                <div class="bg-white rounded-lg shadow-md p-6">
                    <div class="flex justify-between items-center mb-4"><h2 class="text-xl font-bold text-gray-800">Historial de Pedidos</h2><button @click="fetchPedidos" class="text-emerald-500 hover:text-emerald-700"><i class="ph ph-arrow-clockwise text-2xl"></i></button></div>
                    <div v-if="loading" class="text-center py-10"><i class="ph-duotone ph-spinner-gap animate-spin text-4xl text-emerald-500"></i></div>
                     <div v-else-if="pedidos.length === 0" class="text-center py-10"><i class="ph-duotone ph-archive text-5xl text-gray-400"></i><p class="mt-2 text-gray-600">Aún no hay pedidos registrados.</p></div>
                    <div v-else class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="p-3 text-sm font-semibold text-gray-600">ID</th><th class="p-3 text-sm font-semibold text-gray-600">Mesa/Cliente</th><th class="p-3 text-sm font-semibold text-gray-600">Fecha</th><th class="p-3 text-sm font-semibold text-gray-600">Total</th><th class="p-3 text-sm font-semibold text-gray-600">Estado</th><th class="p-3 text-sm font-semibold text-gray-600">Pago</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-200">
                                <tr v-for="pedido in pedidos" :key="pedido.id" class="hover:bg-gray-50">
                                    <td class="p-3 text-sm text-gray-700">#{{ pedido.id }}</td><td class="p-3 text-sm text-gray-700 font-medium">{{ pedido.mesa_nombre }}</td><td class="p-3 text-sm text-gray-500">{{ formatDateTime(pedido.createdAt) }}</td><td class="p-3 text-sm text-gray-800 font-bold">{{ formatCurrency(pedido.total) }}</td>
                                    <td class="p-3 text-sm"><span :class="getStatusClass(pedido.estado)" class="px-2 py-1 rounded-full text-xs font-medium capitalize">{{ pedido.estado.replace('_', ' ') }}</span></td>
                                    <td class="p-3 text-sm">
                                        <span v-if="pedido.pagado" class="px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">Pagado</span>
                                        <span v-else class="px-2 py-1 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">Pendiente</span>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>`,
            setup() {
                const pedidos = ref([]);
                const loading = ref(true);
                const fetchPedidos = async () => {
                    try {
                        loading.value = true;
                        const response = await apiClient.get('/pedidos');
                        pedidos.value = response.data.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                    } catch (error) {
                        console.error("Error cargando pedidos:", error);
                    } finally {
                        loading.value = false;
                    }
                };
                const formatDateTime = (dateString) => new Date(dateString).toLocaleString('es-MX');
                const getStatusClass = (estado) => {
                    const classes = {
                        'en validacion': 'bg-gray-100 text-gray-800', 'en preparacion': 'bg-yellow-100 text-yellow-800',
                        'listo para entregar': 'bg-blue-100 text-blue-800', 'entregado': 'bg-purple-100 text-purple-800',
                        'cancelado': 'bg-red-100 text-red-800'
                    };
                    return classes[estado] || 'bg-gray-100 text-gray-800';
                };
                onMounted(fetchPedidos);
                return { pedidos, loading, fetchPedidos, formatCurrency, formatDateTime, getStatusClass };
            }
        };
        
        const MyOrderView = {
            components: { CartComponent },
            template: `
                <div class="max-w-lg mx-auto">
                    <CartComponent v-if="cart.items.length > 0 && !cart.consumerOrderId" />
                    <div v-else>
                        <div v-if="loading" class="text-center py-20">
                            <i class="ph-duotone ph-spinner-gap animate-spin text-5xl text-emerald-500"></i>
                        </div>
                        <div v-else-if="!cart.consumerOrderId" class="text-center py-20 bg-white rounded-lg shadow-sm">
                            <i class="ph-duotone ph-receipt text-6xl text-gray-300"></i>
                            <h2 class="mt-4 text-2xl font-bold text-gray-700">No tienes un pedido activo</h2>
                            <p class="text-gray-500 mt-2">Una vez que ordenes, podrás ver el estado aquí.</p>
                            <router-link to="/" class="mt-6 inline-block bg-emerald-500 text-white font-bold py-2 px-6 rounded-lg">
                                Empezar a Ordenar
                            </router-link>
                        </div>
                        <div v-else-if="error" class="text-center py-20 bg-white rounded-lg shadow-sm">
                            <i class="ph-duotone ph-x-circle text-6xl text-red-400"></i>
                            <h2 class="mt-4 text-2xl font-bold text-gray-700">No se encontró tu pedido</h2>
                            <p class="text-gray-500 mt-2">{{ error }}</p>
                            <button @click="startNewOrder" class="mt-6 inline-block bg-gray-600 text-white font-bold py-2 px-6 rounded-lg">
                                Limpiar y ordenar de nuevo
                            </button>
                        </div>
                        <div v-else-if="pedido" class="bg-white rounded-lg shadow-md p-6">
                            <div class="text-center border-b pb-4 mb-4">
                                <p class="text-sm text-gray-500">ID de tu Pedido</p>
                                <h2 class="text-3xl font-bold text-emerald-600">#{{ pedido.id }}</h2>
                            </div>
                            <div class="text-center my-8">
                                <p class="text-sm text-gray-500">Estado Actual</p>
                                <div class="mt-2 inline-flex items-center gap-3 px-6 py-3 rounded-full text-2xl font-bold" :class="statusInfo.class">
                                    <i :class="statusInfo.icon"></i>
                                    <span>{{ statusInfo.text }}</span>
                                </div>
                            </div>
                            <ul class="space-y-2 mb-6">
                                <li v-for="detalle in pedido.detalles" :key="detalle.id" class="flex justify-between items-center text-gray-700">
                                    <span>{{ detalle.cantidad }}x {{ detalle.producto.nombre }}</span>
                                    <span class="font-medium">{{ formatCurrency(detalle.cantidad * detalle.precio_unitario) }}</span>
                                </li>
                            </ul>
                            <div class="border-t pt-4 flex justify-between text-xl font-bold">
                                <span>Total:</span>
                                <span>{{ formatCurrency(pedido.total) }}</span>
                            </div>
                            <div v-if="(pedido.estado === 'entregado' && pedido.pagado) || pedido.estado === 'cancelado'" class="text-center mt-8">
                                <button @click="startNewOrder" class="bg-emerald-500 text-white font-bold py-2 px-6 rounded-lg">
                                    Crear un Nuevo Pedido
                                </button>
                            </div>
                        </div>
                    </div>
                </div>`,
            setup() {
                const cart = useCartStore();
                const router = VueRouter.useRouter();
                const pedido = ref(null);
                const loading = ref(true);
                const error = ref(null);
                let socket;
                const fetchPedido = async () => {
                    if (!cart.consumerOrderId) {
                        loading.value = false;
                        return;
                    }
                    loading.value = true;
                    error.value = null;
                    try {
                        const response = await apiClient.get(`/pedidos/${cart.consumerOrderId}`);
                        pedido.value = response.data;
                    } catch (err) {
                        console.error("Error fetching order:", err);
                        if (err.response && err.response.status === 404) {
                            error.value = "No se encontró el pedido. Puede que la ID sea antigua o que el pedido ya no exista en el sistema.";
                            cart.clearConsumerOrder(); // Limpiar la ID inválida
                        } else {
                            error.value = "No se pudo conectar con el servidor para verificar tu pedido.";
                        }
                    } finally {
                        loading.value = false;
                    }
                };
                const statusInfo = computed(() => {
                    if (!pedido.value) return {};
                    if (pedido.value.estado === 'entregado' && pedido.value.pagado) {
                         return { text: '¡Buen provecho!', icon: 'ph-duotone ph-check-circle', class: 'bg-green-100 text-green-800' };
                    }
                    switch(pedido.value.estado) {
                        case 'en validacion': return { text: 'Validando Pedido', icon: 'ph-duotone ph-question', class: 'bg-gray-100 text-gray-800' };
                        case 'en preparacion': return { text: 'En preparación', icon: 'ph-duotone ph-fire', class: 'bg-yellow-100 text-yellow-800' };
                        case 'listo para entregar': return { text: '¡Listo para entregar!', icon: 'ph-duotone ph-bell', class: 'bg-blue-100 text-blue-800' };
                        case 'entregado': return { text: 'Pedido Entregado (Pendiente de pago)', icon: 'ph-duotone ph-smiley', class: 'bg-purple-100 text-purple-800' };
                        case 'cancelado': return { text: 'Cancelado', icon: 'ph-duotone ph-x-circle', class: 'bg-red-100 text-red-800' };
                        default: return { text: 'Desconocido', icon: 'ph-duotone ph-question', class: 'bg-gray-100 text-gray-800' };
                    }
                });
                const startNewOrder = () => {
                    cart.clearConsumerOrder();
                    router.push('/');
                };
                
                onMounted(() => {
                    if (cart.consumerOrderId) {
                        fetchPedido();
                    } else {
                        loading.value = false;
                    }
                    socket = io(backendUrl);
                    socket.on('connect', () => console.log('Socket conectado en Mi Pedido'));
                    socket.on('pedido_actualizado', (pedidoActualizado) => {
                        if (String(pedidoActualizado.id) === String(cart.consumerOrderId)) {
                            pedido.value = pedidoActualizado;
                        }
                    });
                });

                watch(() => cart.consumerOrderId, (newId) => { 
                    if (newId) {
                        fetchPedido();
                    } else {
                        pedido.value = null;
                    }
                });

                onBeforeUnmount(() => { if (socket) socket.disconnect(); });
                return { cart, pedido, loading, error, statusInfo, formatCurrency, startNewOrder };
            }
        };

        const DashboardView = {
            template: `
                <div v-if="loading" class="text-center py-20">
                    <i class="ph-duotone ph-spinner-gap animate-spin text-5xl text-emerald-500"></i>
                    <p class="mt-4 text-gray-600">Cargando estadísticas...</p>
                </div>
                <div v-else-if="stats" class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="bg-white p-6 rounded-lg shadow-md flex items-center gap-4">
                            <i class="ph-duotone ph-chart-bar text-4xl text-blue-500"></i>
                            <div>
                                <p class="text-sm text-gray-500">Ventas Totales</p>
                                <p class="text-2xl font-bold text-gray-800">{{ formatCurrency(stats.totalSales) }}</p>
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow-md flex items-center gap-4">
                            <i class="ph-duotone ph-sun text-4xl text-yellow-500"></i>
                            <div>
                                <p class="text-sm text-gray-500">Ventas de Hoy</p>
                                <p class="text-2xl font-bold text-gray-800">{{ formatCurrency(stats.todaySales) }}</p>
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow-md flex items-center gap-4">
                            <i class="ph-duotone ph-receipt text-4xl text-green-500"></i>
                            <div>
                                <p class="text-sm text-gray-500">Pedidos de Hoy</p>
                                <p class="text-2xl font-bold text-gray-800">{{ stats.todayOrdersCount }}</p>
                            </div>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="lg:col-span-2 bg-white p-6 rounded-lg shadow-md">
                            <h3 class="font-semibold mb-4">Ventas de los Últimos 7 Días</h3>
                            <canvas ref="salesChartCanvas"></canvas>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h3 class="font-semibold mb-4">Productos Más Vendidos</h3>
                            <ul v-if="stats.topSellingProducts.length > 0" class="space-y-3">
                                <li v-for="(item, index) in stats.topSellingProducts" :key="item.productoId" class="flex items-center justify-between">
                                    <div class="flex items-center gap-3">
                                        <span class="font-bold text-gray-400">{{ index + 1 }}</span>
                                        <span class="text-gray-700">{{ item.producto ? item.producto.nombre : 'Producto no disponible' }}</span>
                                    </div>
                                    <span class="font-bold bg-gray-100 px-2 py-1 rounded">{{ item.totalVendido }}</span>
                                </li>
                            </ul>
                            <p v-else class="text-gray-500 text-center py-8">No hay datos de ventas.</p>
                        </div>
                    </div>
                </div>`,
            setup() {
                const loading = ref(true);
                const stats = ref(null);
                const salesChartCanvas = ref(null);
                let chartInstance = null;
                const renderChart = () => {
                    if (chartInstance) {
                        chartInstance.destroy();
                    }
                    if (salesChartCanvas.value && stats.value) {
                        const ctx = salesChartCanvas.value.getContext('2d');
                        chartInstance = new Chart(ctx, {
                            type: 'bar',
                            data: {
                                labels: stats.value.salesLast7Days.map(d => d.date),
                                datasets: [{
                                    label: 'Ventas ($)',
                                    data: stats.value.salesLast7Days.map(d => d.total),
                                    backgroundColor: 'rgba(16, 185, 129, 0.6)',
                                    borderColor: 'rgba(16, 185, 129, 1)',
                                    borderWidth: 1
                                }]
                            },
                            options: { scales: { y: { beginAtZero: true } }, responsive: true, maintainAspectRatio: false }
                        });
                    }
                };
                
                const fetchStats = async () => {
                    try {
                        loading.value = true;
                        const response = await apiClient.get('/dashboard');
                        stats.value = response.data;
                        await nextTick();
                        renderChart();
                    } catch (error) {
                        console.error("Error al cargar el dashboard:", error);
                    } finally {
                        loading.value = false;
                    }
                };

                onMounted(fetchStats);
                onBeforeUnmount(() => { if (chartInstance) chartInstance.destroy(); });

                return { loading, stats, salesChartCanvas, formatCurrency };
            }
        };

        const UserManagementView = {
            template: `
                <div class="bg-white rounded-lg shadow-md p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-800">Gestión de Usuarios</h2>
                        <button @click="openModal()" class="bg-emerald-500 text-white px-4 py-2 rounded-lg flex items-center gap-2 hover:bg-emerald-600">
                            <i class="ph ph-plus"></i>
                            Añadir Usuario
                        </button>
                    </div>

                    <div v-if="loading" class="text-center py-10"><i class="ph-duotone ph-spinner-gap animate-spin text-4xl text-emerald-500"></i></div>
                    <div v-else class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="p-3 text-sm font-semibold text-gray-600">Nombre</th>
                                    <th class="p-3 text-sm font-semibold text-gray-600">Username</th>
                                    <th class="p-3 text-sm font-semibold text-gray-600">Rol</th>
                                    <th class="p-3 text-sm font-semibold text-gray-600 text-right">Acciones</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-200">
                                <tr v-for="user in users" :key="user.id" class="hover:bg-gray-50">
                                    <td class="p-3 text-sm text-gray-700 font-medium">{{ user.nombre }}</td>
                                    <td class="p-3 text-sm text-gray-500">{{ user.username }}</td>
                                    <td class="p-3 text-sm text-gray-700 capitalize">{{ user.role }}</td>
                                    <td class="p-3 text-sm text-right">
                                        <button @click="openModal(user)" class="text-blue-500 hover:text-blue-700 mr-4">Editar</button>
                                        <button @click="confirmDelete(user)" class="text-red-500 hover:text-red-700" :disabled="isCurrentUser(user.id)">Eliminar</button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Modal para crear/editar usuario -->
                <div v-if="isModalOpen" @click.self="closeModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                    <div class="w-full max-w-md bg-white rounded-lg shadow-md p-8">
                        <h3 class="text-2xl font-bold mb-6">{{ isEditMode ? 'Editar Usuario' : 'Añadir Usuario' }}</h3>
                        <form @submit.prevent="handleSubmit">
                            <div class="mb-4">
                                <label for="nombre" class="block text-sm font-medium text-gray-700">Nombre Completo</label>
                                <input v-model="currentUser.nombre" type="text" id="nombre" class="mt-1 block w-full" required>
                            </div>
                            <div class="mb-4">
                                <label for="username" class="block text-sm font-medium text-gray-700">Username</label>
                                <input v-model="currentUser.username" type="text" id="username" class="mt-1 block w-full" required>
                            </div>
                            <div class="mb-4">
                                <label for="password" class="block text-sm font-medium text-gray-700">Contraseña</label>
                                <input v-model="currentUser.password" type="password" id="password" class="mt-1 block w-full" :placeholder="isEditMode ? 'Dejar en blanco para no cambiar' : ''" :required="!isEditMode">
                            </div>
                            <div class="mb-6">
                                <label for="role" class="block text-sm font-medium text-gray-700">Rol</label>
                                <select v-model="currentUser.role" id="role" class="mt-1 block w-full" required>
                                    <option value="mesero">Mesero</option>
                                    <option value="cocinero">Cocinero</option>
                                    <option value="administrador">Administrador</option>
                                </select>
                            </div>
                            <div class="flex justify-end gap-4">
                                <button type="button" @click="closeModal" class="px-4 py-2 bg-gray-200 rounded-lg">Cancelar</button>
                                <button type="submit" class="px-4 py-2 bg-emerald-500 text-white rounded-lg">{{ isEditMode ? 'Guardar Cambios' : 'Crear Usuario' }}</button>
                            </div>
                        </form>
                    </div>
                </div>
            `,
            setup() {
                const auth = useAuthStore();
                const users = ref([]);
                const loading = ref(true);
                const isModalOpen = ref(false);
                const isEditMode = ref(false);
                const currentUser = ref({});

                const fetchUsers = async () => {
                    try {
                        loading.value = true;
                        const response = await apiClient.get('/users');
                        users.value = response.data;
                    } catch (error) {
                        console.error("Error al cargar usuarios:", error);
                    } finally {
                        loading.value = false;
                    }
                };
                
                const openModal = (user = null) => {
                    if (user) {
                        isEditMode.value = true;
                        currentUser.value = { ...user, password: '' }; // Clonar para no modificar la lista directamente
                    } else {
                        isEditMode.value = false;
                        currentUser.value = { nombre: '', username: '', password: '', role: 'mesero' };
                    }
                    isModalOpen.value = true;
                };

                const closeModal = () => {
                    isModalOpen.value = false;
                };

                const handleSubmit = async () => {
                    try {
                        const data = { ...currentUser.value };
                        // No enviar la contraseña si está vacía en modo edición
                        if (isEditMode.value && !data.password) {
                            delete data.password;
                        }

                        if (isEditMode.value) {
                            await apiClient.put(`/users/${data.id}`, data);
                        } else {
                            await apiClient.post('/users', data);
                        }
                        fetchUsers();
                        closeModal();
                    } catch (error) {
                        console.error("Error al guardar usuario:", error);
                        alert(error.response?.data?.message || 'No se pudo guardar el usuario.');
                    }
                };

                const confirmDelete = (user) => {
                    if (confirm(`¿Estás seguro de que quieres eliminar a ${user.nombre}?`)) {
                        deleteUser(user.id);
                    }
                };

                const deleteUser = async (userId) => {
                    try {
                        await apiClient.delete(`/users/${userId}`);
                        fetchUsers();
                    } catch (error) {
                        console.error("Error al eliminar usuario:", error);
                        alert(error.response?.data?.message || 'No se pudo eliminar el usuario.');
                    }
                };

                const isCurrentUser = (userId) => {
                    return auth.user?.id === userId;
                };

                onMounted(fetchUsers);

                return { users, loading, isModalOpen, isEditMode, currentUser, openModal, closeModal, handleSubmit, confirmDelete, isCurrentUser };
            }
        };

        const MenuAdminView = {
            template: `
                <div class="space-y-8">
                    <!-- Sección de Gestión de Categorías -->
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-2xl font-bold text-gray-800">Categorías</h2>
                            <button @click="openCategoryModal()" class="bg-emerald-500 text-white px-4 py-2 rounded-lg flex items-center gap-2 hover:bg-emerald-600">
                                <i class="ph ph-plus"></i> Añadir Categoría
                            </button>
                        </div>
                        <ul class="space-y-2">
                            <li v-for="cat in categories" :key="cat.id" class="flex justify-between items-center p-3 rounded-lg" :class="cat.visible ? 'bg-gray-50' : 'bg-red-50'">
                                <div>
                                    <span class="font-medium" :class="{'text-gray-400 line-through': !cat.visible}">{{ cat.nombre }}</span>
                                    <span v-if="!cat.visible" class="text-xs text-red-600 font-semibold ml-2">OCULTO</span>
                                </div>
                                <div class="space-x-2">
                                    <button @click="openCategoryModal(cat)" class="text-blue-500 hover:text-blue-700 p-1"><i class="ph ph-pencil-simple"></i></button>
                                    <button v-if="cat.visible" @click="toggleVisibility('category', cat)" class="text-red-500 hover:text-red-700 p-1" title="Ocultar"><i class="ph ph-eye-slash"></i></button>
                                    <button v-else @click="toggleVisibility('category', cat)" class="text-green-500 hover:text-green-700 p-1" title="Restaurar"><i class="ph ph-eye"></i></button>
                                </div>
                            </li>
                        </ul>
                    </div>

                    <!-- Sección de Gestión de Productos -->
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-2xl font-bold text-gray-800">Productos</h2>
                            <button @click="openProductModal()" class="bg-emerald-500 text-white px-4 py-2 rounded-lg flex items-center gap-2 hover:bg-emerald-600">
                                <i class="ph ph-plus"></i> Añadir Producto
                            </button>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="p-3 text-sm font-semibold text-gray-600">Producto</th>
                                        <th class="p-3 text-sm font-semibold text-gray-600">Categoría</th>
                                        <th class="p-3 text-sm font-semibold text-gray-600">Precio</th>
                                        <th class="p-3 text-sm font-semibold text-gray-600">Estado</th>
                                        <th class="p-3 text-sm font-semibold text-gray-600 text-right">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-200">
                                    <tr v-for="prod in products" :key="prod.id" class="hover:bg-gray-50" :class="{'opacity-50': !prod.visible}">
                                        <td class="p-3 font-medium flex items-center gap-3">
                                            <img :src="prod.imagen_url || 'https://placehold.co/40x40/e2e8f0/64748b?text=??'" class="w-10 h-10 rounded-md object-cover">
                                            <span>{{ prod.nombre }}</span>
                                        </td>
                                        <td class="p-3 text-sm text-gray-500">{{ prod.categoria ? prod.categoria.nombre : 'N/A' }}</td>
                                        <td class="p-3 text-sm text-gray-800 font-semibold">{{ formatCurrency(prod.precio) }}</td>
                                        <td class="p-3 text-sm">
                                            <span class="px-2 py-1 rounded-full text-xs font-medium" :class="prod.visible ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'">
                                                {{ prod.visible ? 'Visible' : 'Oculto' }}
                                            </span>
                                        </td>
                                        <td class="p-3 text-right">
                                            <button @click="openProductModal(prod)" class="text-blue-500 hover:text-blue-700 p-1"><i class="ph ph-pencil-simple"></i></button>
                                            <button v-if="prod.visible" @click="toggleVisibility('product', prod)" class="text-red-500 hover:text-red-700 p-1" title="Ocultar"><i class="ph ph-eye-slash"></i></button>
                                            <button v-else @click="toggleVisibility('product', prod)" class="text-green-500 hover:text-green-700 p-1" title="Restaurar"><i class="ph ph-eye"></i></button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Modal para Categorías -->
                    <div v-if="categoryModal.isOpen" @click.self="closeCategoryModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                        <div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-md">
                            <h3 class="text-2xl font-bold mb-6">{{ categoryModal.isEdit ? 'Editar' : 'Nueva' }} Categoría</h3>
                            <form @submit.prevent="handleCategorySubmit">
                                <div class="mb-4">
                                    <label for="cat-nombre" class="block text-sm font-medium text-gray-700">Nombre</label>
                                    <input v-model="categoryModal.current.nombre" id="cat-nombre" type="text" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm" required>
                                </div>
                                <div class="flex justify-end gap-4 mt-8">
                                    <button type="button" @click="closeCategoryModal" class="px-4 py-2 bg-gray-200 rounded-lg">Cancelar</button>
                                    <button type="submit" class="px-4 py-2 bg-emerald-500 text-white rounded-lg">Guardar</button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- Modal para Productos -->
                    <div v-if="productModal.isOpen" @click.self="closeProductModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                        <div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-lg">
                            <h3 class="text-2xl font-bold mb-6">{{ productModal.isEdit ? 'Editar' : 'Nuevo' }} Producto</h3>
                            <form @submit.prevent="handleProductSubmit" class="space-y-4">
                                <input v-model="productModal.current.nombre" type="text" placeholder="Nombre del producto" class="w-full border-gray-300 rounded-md shadow-sm" required>
                                <textarea v-model="productModal.current.descripcion" placeholder="Descripción" class="w-full border-gray-300 rounded-md shadow-sm" rows="3"></textarea>
                                <input v-model="productModal.current.precio" type="number" step="0.01" placeholder="Precio" class="w-full border-gray-300 rounded-md shadow-sm" required>
                                <select v-model="productModal.current.categoriaId" class="w-full border-gray-300 rounded-md shadow-sm" required>
                                    <option :value="null" disabled>Selecciona una categoría</option>
                                    <option v-for="cat in categories.filter(c => c.visible)" :key="cat.id" :value="cat.id">{{ cat.nombre }}</option>
                                </select>
                                <div>
                                    <label for="prod-imagen" class="block text-sm font-medium text-gray-700">Imagen del Producto</label>
                                    <input @change="handleImageUpload" id="prod-imagen" type="file" accept="image/*" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-emerald-50 file:text-emerald-700 hover:file:bg-emerald-100">
                                    <div v-if="imagePreviewUrl || productModal.current.imagen_url" class="mt-4 border rounded-md p-2 inline-block">
                                        <img :src="imagePreviewUrl || productModal.current.imagen_url" class="w-32 h-32 object-cover rounded-md">
                                    </div>
                                </div>
                                <div class="flex justify-end gap-4 pt-4">
                                    <button type="button" @click="closeProductModal" class="px-4 py-2 bg-gray-200 rounded-lg">Cancelar</button>
                                    <button type="submit" class="px-4 py-2 bg-emerald-500 text-white rounded-lg">Guardar</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            `,
            setup() {
                const products = ref([]);
                const categories = ref([]);
                const loading = ref(true);

                const categoryModal = ref({ isOpen: false, isEdit: false, current: {} });
                const productModal = ref({ isOpen: false, isEdit: false, current: {} });
                const imagePreviewUrl = ref(null);
                const selectedFile = ref(null);

                const fetchData = async () => {
                    loading.value = true;
                    try {
                        const [prodRes, catRes] = await Promise.all([
                            apiClient.get('/productos/admin/all'),
                            apiClient.get('/categorias/admin/all')
                        ]);
                        products.value = prodRes.data;
                        categories.value = catRes.data;
                    } catch (error) {
                        console.error("Error al cargar datos de menú:", error);
                        alert("No se pudieron cargar los datos del menú.");
                    } finally {
                        loading.value = false;
                    }
                };

                const handleImageUpload = (event) => {
                    const file = event.target.files[0];
                    if (file) {
                        selectedFile.value = file;
                        imagePreviewUrl.value = URL.createObjectURL(file);
                    }
                };

                // --- Lógica de Categorías ---
                const openCategoryModal = (cat = null) => {
                    if (cat) {
                        categoryModal.value = { isOpen: true, isEdit: true, current: { ...cat } };
                    } else {
                        categoryModal.value = { isOpen: true, isEdit: false, current: { nombre: '' } };
                    }
                };
                const closeCategoryModal = () => categoryModal.value.isOpen = false;
                const handleCategorySubmit = async () => {
                    const { isEdit, current } = categoryModal.value;
                    try {
                        if (isEdit) {
                            await apiClient.put(`/categorias/${current.id}`, current);
                        } else {
                            await apiClient.post('/categorias', current);
                        }
                        await fetchData();
                        closeCategoryModal();
                    } catch (error) {
                        alert(error.response?.data?.message || 'Error al guardar la categoría.');
                    }
                };

                // --- Lógica de Productos ---
                const openProductModal = (prod = null) => {
                    imagePreviewUrl.value = null;
                    selectedFile.value = null;
                    if (prod) {
                        productModal.value = { isOpen: true, isEdit: true, current: { ...prod } };
                    } else {
                        productModal.value = { isOpen: true, isEdit: false, current: { nombre: '', descripcion: '', precio: '', imagen_url: '', categoriaId: null } };
                    }
                };
                const closeProductModal = () => productModal.value.isOpen = false;
                const handleProductSubmit = async () => {
                    const { isEdit, current } = productModal.value;
                    
                    const formData = new FormData();
                    formData.append('nombre', current.nombre);
                    formData.append('descripcion', current.descripcion || '');
                    formData.append('precio', current.precio);
                    formData.append('categoriaId', current.categoriaId);

                    if (selectedFile.value) {
                        formData.append('imagen', selectedFile.value);
                    }

                    try {
                        const config = { headers: { 'Content-Type': 'multipart/form-data' } };
                        if (isEdit) {
                            await apiClient.put(`/productos/admin/${current.id}`, formData, config);
                        } else {
                            await apiClient.post('/productos/admin', formData, config);
                        }
                        await fetchData();
                        closeProductModal();
                    } catch (error) {
                        alert(error.response?.data?.message || 'Error al guardar el producto.');
                    }
                };

                const toggleVisibility = async (type, item) => {
                    const endpoint = type === 'category' ? `/categorias/${item.id}` : `/productos/${item.id}`;
                    
                    try {
                        if (item.visible) {
                            await apiClient.delete(endpoint);
                        } else {
                            await apiClient.patch(`${endpoint}/restore`);
                        }
                        await fetchData();
                    } catch (error) {
                        alert(error.response?.data?.message || `Error al cambiar la visibilidad.`);
                    }
                };

                onMounted(fetchData);

                return { products, categories, loading, categoryModal, productModal, imagePreviewUrl, handleImageUpload, openCategoryModal, closeCategoryModal, handleCategorySubmit, openProductModal, closeProductModal, handleProductSubmit, toggleVisibility, formatCurrency };
            }
        };

        // --- ROUTER ---
        const MainLayout = {
            components: { LoginModal },
            template: `
                <div class="flex flex-col h-screen">
                    <header class="h-16 bg-white border-b border-gray-200 flex items-center justify-between px-6 shrink-0">
                        <div class="flex items-center gap-3">
                            <i class="ph-duotone ph-storefront text-3xl text-emerald-500"></i>
                            <h1 class="text-xl font-semibold text-gray-800">{{ $route.meta.title }}</h1>
                        </div>
                    </header>
                    <!-- CONTENEDOR PRINCIPAL: Se ha añadido un padding inferior (pb-28) para dejar espacio para la barra de navegación fija -->
                    <main class="flex-1 overflow-y-auto p-4 pb-28">
                        <router-view v-slot="{ Component }"><transition name="fade" mode="out-in"><component :is="Component" /></transition></router-view>
                    </main>
                    <nav class="fixed bottom-0 left-0 right-0 h-20 bg-white border-t border-gray-200 shadow-lg flex justify-around items-center z-10">
                        <template v-if="!auth.isAuthenticated">
                            <router-link to="/" class="bottom-nav-link flex flex-col items-center text-gray-600">
                                <i class="ph-duotone ph-cooking-pot text-3xl"></i><span class="text-xs font-medium">Ordenar</span>
                            </router-link>
                            <router-link to="/mi-pedido" class="bottom-nav-link relative flex flex-col items-center text-gray-600">
                                <span v-if="cart.totalItems > 0" class="absolute top-1 right-1/2 transform translate-x-3 bg-red-500 text-white text-xs font-bold rounded-full h-5 w-5 flex items-center justify-center">
                                    {{ cart.totalItems }}
                                </span>
                                <i class="ph-duotone ph-receipt text-3xl"></i><span class="text-xs font-medium">Mi Pedido</span>
                            </router-link>
                            <button @click="auth.openLoginModal()" class="bottom-nav-link flex flex-col items-center text-gray-600">
                                <i class="ph-duotone ph-user-circle text-3xl"></i><span class="text-xs font-medium">Staff</span>
                            </button>
                        </template>
                        <template v-else>
                             <router-link v-if="auth.hasRole(['administrador'])" to="/dashboard" class="bottom-nav-link flex flex-col items-center text-gray-600">
                                <i class="ph-duotone ph-gauge text-3xl"></i><span class="text-xs font-medium">Dashboard</span>
                            </router-link>
                             <router-link v-if="auth.hasRole(['administrador'])" to="/menu-admin" class="bottom-nav-link flex flex-col items-center text-gray-600">
                                <i class="ph-duotone ph-list-dashes text-3xl"></i><span class="text-xs font-medium">Menú</span>
                            </router-link>
                             <router-link v-if="auth.hasRole(['administrador'])" to="/users" class="bottom-nav-link flex flex-col items-center text-gray-600">
                                <i class="ph-duotone ph-users-three text-3xl"></i><span class="text-xs font-medium">Usuarios</span>
                            </router-link>
                            <router-link v-if="auth.hasRole(['mesero', 'administrador'])" to="/mesero" class="bottom-nav-link flex flex-col items-center text-gray-600">
                                <i class="ph-duotone ph-user-list text-3xl"></i><span class="text-xs font-medium">Gestionar</span>
                            </router-link>
                             <router-link v-if="auth.hasRole(['mesero', 'administrador'])" to="/crear-pedido" class="bottom-nav-link flex flex-col items-center text-gray-600">
                                <i class="ph-duotone ph-notepad text-3xl"></i><span class="text-xs font-medium">Crear Pedido</span>
                            </router-link>
                            <router-link v-if="auth.hasRole(['mesero', 'administrador'])" to="/ingresar-pedido" class="bottom-nav-link relative flex flex-col items-center text-gray-600">
                                <span v-if="cart.totalItems > 0 && $route.path !== '/ingresar-pedido'" class="absolute top-0 right-1/2 transform translate-x-4 bg-red-500 text-white text-xs font-bold rounded-full h-5 w-5 flex items-center justify-center">
                                    {{ cart.totalItems }}
                                </span>
                                <i class="ph-duotone ph-arrow-circle-right text-3xl"></i><span class="text-xs font-medium">Ingresar</span>
                            </router-link>
                            <router-link v-if="auth.hasRole(['cocinero', 'administrador'])" to="/cocina" class="bottom-nav-link flex flex-col items-center text-gray-600">
                                <i class="ph-duotone ph-fire text-3xl"></i><span class="text-xs font-medium">Cocina</span>
                            </router-link>
                            <button @click="auth.logout()" class="bottom-nav-link flex flex-col items-center text-gray-600">
                                <i class="ph-duotone ph-sign-out text-3xl"></i><span class="text-xs font-medium">Salir</span>
                            </button>
                        </template>
                    </nav>
                    <LoginModal />
                </div>`,
            setup() {
                const auth = useAuthStore();
                const cart = useCartStore();
                return { auth, cart };
            }
        };

        const routes = [
            { 
                path: '/', 
                component: MainLayout,
                children: [
                    { path: '', component: TakeOrderView, meta: { title: 'Realizar Pedido' } },
                    { path: 'mi-pedido', component: MyOrderView, meta: { title: 'Mi Pedido' } },
                    { path: 'dashboard', component: DashboardView, meta: { title: 'Dashboard', requiresAuth: true, roles: ['administrador'] } },
                    { path: 'users', component: UserManagementView, meta: { title: 'Gestión de Usuarios', requiresAuth: true, roles: ['administrador'] } },
                    { path: 'menu-admin', component: MenuAdminView, meta: { title: 'Gestión de Menú', requiresAuth: true, roles: ['administrador'] } },
                    { path: 'mesero', component: WaiterView, meta: { title: 'Gestionar Pedidos', requiresAuth: true, roles: ['mesero', 'administrador'] } },
                    { path: 'crear-pedido', component: WaiterOrderView, meta: { title: 'Crear Pedido', requiresAuth: true, roles: ['mesero', 'administrador'] } },
                    { path: 'ingresar-pedido', component: SubmitOrderView, meta: { title: 'Ingresar Pedido', requiresAuth: true, roles: ['mesero', 'administrador'] } },
                    { path: 'cocina', component: KitchenView, meta: { title: 'Vista de Cocina', requiresAuth: true, roles: ['cocinero', 'administrador'] } },
                    { path: 'pedidos', component: OrdersHistoryView, meta: { title: 'Historial', requiresAuth: true, roles: ['mesero', 'administrador'] } },
                ]
            }
        ];

        const router = createRouter({ history: createWebHashHistory(), routes });
        
        router.beforeEach((to, from, next) => {
            const auth = useAuthStore();
            const token = localStorage.getItem('token');
            const user = JSON.parse(localStorage.getItem('user'));
            
            if (token && user) {
                auth.token = token;
                auth.user = user;
            }

            if (to.meta.requiresAuth && !auth.isAuthenticated) {
                auth.openLoginModal();
                if (from.path === '/') return;
                next('/');
            } else if (to.meta.requiresAuth && to.meta.roles && !auth.hasRole(to.meta.roles)) {
                if(auth.hasRole(['cocinero'])) next('/cocina');
                else if(auth.hasRole(['mesero'])) next('/mesero');
                else if(auth.hasRole(['administrador'])) next('/dashboard');
                else next('/');
            } else {
                next();
            }
        });

        // --- APP PRINCIPAL ---
        const app = createApp({ template: '<router-view />' });
        const pinia = createPinia();
        app.use(pinia);
        app.use(router);
        app.mount('#app');
    </script>
</body>
</html>
